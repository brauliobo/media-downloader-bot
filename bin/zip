#!/usr/bin/env ruby

STDOUT.sync = true
ENV['PRINT_CMD'] = '1'
ENV['SKIP_META'] = '1'
ENV['DB'] = '1' if ENV['SESSION_UID']
ENV['PUPPETEER_HEADLESS'] ||= '0'

Dir.chdir File.expand_path "#{File.realpath __dir__}/.." do
  require_relative '../lib/worker'
  require_relative '../lib/bot/base'
end

opts  = SymMash.new metadata: {}
lopts = []
while ARGV[-1] and !File.exist?(ARGV[-1]) and ARGV[-1] !~ URI::regexp
  opt = ARGV.pop
  lopts.push opt
  Processors::Base.add_opt opts, opt
end

Zipper.size_mb_limit = ENV['SIZE_MB_LIMIT']&.to_i

bot = Bot::Mock.new
Worker.service = bot

raise "No files found" if ARGV.blank?
path = if ARGV.size > 1 then ARGV else ARGV.first&.split "\n" end
path.peach do |u|
  fake_msg = MsgHelpers.fake_msg
  fake_msg.bot = bot

  # Handle local files
  if File.exist?(u)
    Processors::LocalFile.attach_to_message(fake_msg, u, opts: lopts)
  else
    # Handle URLs
    line = u =~ URI::regexp ? "#{u} #{lopts.join ' '}" : u
    fake_msg.text = line
  end

  worker = Worker.new fake_msg
  worker.process
end

